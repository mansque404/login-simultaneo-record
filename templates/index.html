<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de testes do QA</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Painel de Testes do QA</h1>
        </header>

        <main>
            <section class="card">
                <h2>Painel de Controle</h2>
                <div class="form-group">
                    <label for="num_logins">Quantidade de Logins Simultâneos:</label>
                    <input type="number" id="num_logins" name="num_logins" min="1" value="5">
                </div>
                <button onclick="executeLogins()">
                    <svg id="button-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 3l14 9-14 9V3z"></path></svg>
                    <span id="button-text">Executar Teste</span>
                </button>
            </section>

            <section id="results-panel" class="card">
                <h2>Resultados da Execução</h2>
                <div class="metrics">
                    <div class="metric-card" id="metric-total-logins">
                        <div class="label">Total de Logins</div>
                        <div class="value" id="value-total-logins">0</div>
                    </div>
                    <div class="metric-card" id="metric-time">
                        <div class="label">Tempo Total</div>
                        <div class="value" id="value-total-time">0s</div>
                    </div>
                    <div class="metric-card" id="metric-success">
                        <div class="label">Sucessos</div>
                        <div class="value" id="value-success">0</div>
                    </div>
                    <div class="metric-card" id="metric-failure">
                        <div class="label">Falhas</div>
                        <div class="value" id="value-failure">0</div>
                    </div>
                </div>
                <table id="status_table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Status</th>
                            <th>Token / Mensagem</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <script>
        const ICONS = {
            play: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 3l14 9-14 9V3z"></path></svg>`,
            loading: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg>`,
            success: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14 9 11"></polyline></svg>`,
            failure: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`
        };

        const button = document.querySelector("button");
        const buttonIcon = document.getElementById("button-icon");
        const buttonText = document.getElementById("button-text");
        const resultsPanel = document.getElementById("results-panel");
        const resultsTbody = document.querySelector("#status_table tbody");
        const numLoginsInput = document.getElementById('num_logins'); 

        const valueTotalLogins = document.getElementById("value-total-logins");
        const valueTotalTime = document.getElementById("value-total-time");
        const valueSuccess = document.getElementById("value-success");
        const valueFailure = document.getElementById("value-failure");
        
        async function executeLogins() {
            if (button.disabled) return;

            const numLogins = numLoginsInput.value;
            
            button.disabled = true;
            buttonText.innerText = 'Executando...';
            buttonIcon.innerHTML = ICONS.loading;
            resultsPanel.style.display = 'none';
            resultsTbody.innerHTML = ''; 

            try {
                const response = await fetch('/execute_logins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ num_logins: parseInt(numLogins) }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro no servidor: ${response.statusText}`);
                }

                const data = await response.json();
                
                const successCount = data.results.filter(r => r.status === 'Sucesso').length;
                const failureCount = data.results.length - successCount;

                valueTotalLogins.innerText = data.results.length;
                valueTotalTime.innerText = `${data.total_time.toFixed(2)}s`;
                valueSuccess.innerText = successCount;
                valueFailure.innerText = failureCount;

                data.results.forEach((result, index) => {
                    const row = resultsTbody.insertRow();
                    row.insertCell(0).innerText = index + 1;
                    
                    const statusCell = row.insertCell(1);
                    if (result.status === 'Sucesso') {
                        statusCell.innerHTML = `<span class="status-icon status-success">${ICONS.success} Sucesso</span>`;
                    } else {
                        statusCell.innerHTML = `<span class="status-icon status-failure">${ICONS.failure} Falha</span>`;
                    }
                    
                    row.insertCell(2).innerText = result.token || result.message;
                });

            } catch (error) {
                console.error('Erro ao executar os logins:', error);
                alert('Ocorreu um erro: ' + error.message);
            } finally {
                resultsPanel.style.display = 'block';
                button.disabled = false;
                buttonText.innerText = 'Executar Teste';
                buttonIcon.innerHTML = ICONS.play;
            }
        }
        
        numLoginsInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                executeLogins();
            }
        });

    </script>
</body>
</html>